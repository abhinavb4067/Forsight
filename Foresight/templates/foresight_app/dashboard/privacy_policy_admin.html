{% extends 'foresight_app/dashboard/base.html' %}
{% block content %}
<div class="pt-24 md:ml-64 p-4 space-y-10">
  <section class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-semibold mb-2 text-center">Privacy Policy Management</h2>

    <!-- Add Button -->
    {% if policies %}
    <button class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded mb-4" onclick="showPrivacyNotice()">➕ Add New Policy</button>
    {% else %}
    <button class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded mb-4" onclick="openModal('privacyAddModal')">➕ Add New Policy</button>
    {% endif %}

    <!-- Notification -->
    <div id="privacyNotice" class="notice-hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded shadow z-50 text-sm">
      ⚠️ Please edit the existing privacy policy instead of adding a new one.
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left border border-gray-200 mt-4">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="border px-4 py-2">Policy</th>
            <th class="border px-4 py-2 w-32">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if policies %}
          {% for policy in policies %}
          <tr class="hover:bg-gray-50">
            <td class="border px-4 py-2 whitespace-pre-line">{{ policy.policy }}</td>
            <td class="border px-4 py-2">
              <div class="flex gap-2">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs" onclick="openModal('privacyEditModal{{ policy.id }}')">Edit</button>
                <a href="{% url 'delete_privacy_policy' policy.id %}" onclick="return confirm('Are you sure?')">
                  <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">Delete</button>
                </a>
              </div>
            </td>
          </tr>

          <!-- Edit Modal -->
          <div id="privacyEditModal{{ policy.id }}" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden justify-center items-center">
            <div class="bg-white rounded-lg p-6 w-[90%] max-w-2xl relative">
              <span class="absolute top-2 right-4 text-xl font-bold text-gray-600 cursor-pointer" onclick="closeModalprivacy('privacyEditModal{{ policy.id }}')">&times;</span>
              <form action="{% url 'edit_privacy_policy' policy.id %}" method="POST">
                {% csrf_token %}
                <h5 class="text-lg font-semibold mb-3">Edit Privacy Policy</h5>
                <textarea name="policy" rows="8" class="w-full p-3 border border-gray-300 rounded mb-4" required>{{ policy.policy }}</textarea>
                <div class="text-right">
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Update</button>
                </div>
              </form>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="2" class="text-center py-4 font-semibold text-gray-500">No privacy policies available. Please add a new policy.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- Add Modal -->
<div id="privacyAddModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg p-6 w-[90%] max-w-2xl relative">
    <span class="absolute top-2 right-4 text-xl font-bold text-gray-600 cursor-pointer" onclick="closeModalprivacy('privacyAddModal')">&times;</span>
    <form action="{% url 'add_privacy_policy' %}" method="POST">
      {% csrf_token %}
      <h5 class="text-lg font-semibold mb-3">Add New Privacy Policy</h5>
      <textarea name="policy" rows="8" class="w-full p-3 border border-gray-300 rounded mb-4" placeholder="Enter new policy..." required></textarea>
      <div class="text-right">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- JS -->
<script>
  function showPrivacyNotice() {
    const notice = document.getElementById('privacyNotice');
    notice.classList.remove('notice-hidden');
    notice.classList.add('notice-show');
    setTimeout(() => {
      notice.classList.remove('notice-show');
    }, 4000);
  }

  function openModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeModalprivacy(id) {
    const modal = document.getElementById(id);
    modal.classList.remove("flex");
    modal.classList.add("hidden");
  }

  window.onclick = function(event) {
    const modals = document.querySelectorAll('[id^="privacyEditModal"], #privacyAddModal');
    modals.forEach(modal => {
      if (event.target === modal) {
        modal.classList.remove("flex");
        modal.classList.add("hidden");
      }
    });
  }
</script>

<!-- Minimal styling for animation notice -->
<style>
  .notice-hidden {
    display: none;
  }

  .notice-show {
    display: block;
    animation: fadeOut 4s forwards;
  }

  @keyframes fadeOut {
    0%   { opacity: 1; }
    80%  { opacity: 1; }
    100% { opacity: 0; display: none; }
  }
</style>
{% endblock %}
