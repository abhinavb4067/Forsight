{% extends 'foresight_app/dashboard/base.html' %}

{% block content %}
<body class="bg-gray-100 min-h-screen p-4">
    <div class="pt-24 md:ml-64 p-4 space-y-10">
{% if messages %}
  <div class="space-y-2 mb-4">
    {% for message in messages %}
      <div class="px-4 py-2 rounded text-white
        {% if message.tags == 'success' %} bg-green-500
        {% elif message.tags == 'error' %} bg-red-500
        {% elif message.tags == 'info' %} bg-blue-500
        {% else %} bg-gray-500
        {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

      <section class="bg-white p-6 rounded-lg shadow-md">


  <h2 class="text-2xl font-semibold mb-4 text-center">Students Management</h2>


    <!-- Filters -->
    <div class="flex flex-col md:flex-row md:gap-6 gap-4 mb-6">
   <form method="get" id="filterForm" class="flex flex-col md:flex-row md:gap-6 gap-4 mb-6">
  <div class="flex-1">
    <label class="block font-semibold mb-1">Filter by Course</label>
    <select id="course" name="course" class="w-full border rounded px-3 py-2" onchange="document.getElementById('filterForm').submit()">
      <option value="" disabled {% if not selected_course %}selected{% endif %}>Select a course</option>
      <option value="Hotel and Hospitality Management" {% if selected_course == "Hotel and Hospitality Management" %}selected{% endif %}>Hotel and Hospitality Management</option>
      <option value="Diploma in Food Production & Culinary Arts" {% if selected_course == "Diploma in Food Production & Culinary Arts" %}selected{% endif %}>Diploma in Food Production & Culinary Arts</option>
      <option value="Diploma in Housekeeping Operations" {% if selected_course == "Diploma in Housekeeping Operations" %}selected{% endif %}>Diploma in Housekeeping Operations</option>
      <option value="Diploma in Food and Beverage Service" {% if selected_course == "Diploma in Food and Beverage Service" %}selected{% endif %}>Diploma in Food and Beverage Service</option>
      <option value="Diploma in Kitchen Supervisor" {% if selected_course == "Diploma in Kitchen Supervisor" %}selected{% endif %}>Diploma in Kitchen Supervisor</option>
      <option value="Diploma in Front Office Services" {% if selected_course == "Diploma in Front Office Services" %}selected{% endif %}>Diploma in Front Office Services</option>
      <option value="Diploma in Kitchen & Area Sanitizing" {% if selected_course == "Diploma in Kitchen & Area Sanitizing" %}selected{% endif %}>Diploma in Kitchen & Area Sanitizing</option>
      <option value="Diploma in USPH & HACCP Compliance" {% if selected_course == "Diploma in USPH & HACCP Compliance" %}selected{% endif %}>Diploma in USPH & HACCP Compliance</option>
    </select>
  </div>

  <div class="flex-1">
    <label class="block font-semibold mb-1">Register Date</label>
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
      <input type="date" name="from_date" value="{{ from_date }}" class="border rounded px-3 py-2 w-full sm:w-auto" onchange="document.getElementById('filterForm').submit()" />
      <span class="hidden sm:inline">to</span>
      <input type="date" name="to_date" value="{{ to_date }}" class="border rounded px-3 py-2 w-full sm:w-auto" onchange="document.getElementById('filterForm').submit()" />
    </div>
  </div>
</form>
<form method="POST">
  {% csrf_token %}
      <div class="flex-1">
        <label class="block font-semibold mb-1">Set batch: (set by admin)<span class="text-red-500">*</span></label>
        <select class="w-full border rounded px-3 py-2" id="batch" name="batch" required>
          <option value="" disabled selected>Select a batch</option>
          <option value="2025-2026">2025-2026</option>
          <option value="2026-2027">2026-2027</option>
          <option value="2027-2028">2027-2028</option>
          <option value="2028-2029">2028-2029</option>
          <option value="2029-2030">2029-2030</option>
          <option value="2030-2031">2030-2031</option>
          <option value="2031-2032">2031-2032</option>
        </select>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto relative">
 <table class="min-w-full border border-gray-300">
  <thead class="bg-gray-200">
    <tr>
      <th class="border px-4 py-2 text-left sticky left-0 z-10 bg-gray-200 w-40">S Name</th>
      {% for class in classes %}
        <th class="border px-4 py-2 text-center min-w-[120px] bg-gray-100">
          {{ class.name }}<br/>
          <input type="checkbox" id="selectAllClass{{ forloop.counter0 }}" onclick="selectAll(this, {{ forloop.counter0 }})" />
        </th>
      {% endfor %}
    </tr>
  </thead>

  <tbody class="text-center">
  {% for student in students %}
    <tr>
      <td class="border px-4 py-2 text-left sticky left-0 bg-white w-40">
        {{ student.full_name }}
      </td>
      {% for class in classes %}
        <td class="border px-4 py-2">
          <input type="checkbox"
                 name="class{{ forloop.counter0 }}_{{ student.id }}"
                 class="class{{ forloop.counter0 }}"
                 onclick="onlyOne(this)"
                 {% for assign in assignments %}
                   {% if assign.student.id == student.id and assign.class_name.id == class.id %}
                     checked
                   {% endif %}
                 {% endfor %} />
        </td>
      {% endfor %}
    </tr>
  {% empty %}
    <tr>
      <td colspan="{{ classes|length|add:'1' }}" class="text-center text-gray-500 py-4">
        No students found for selected filters.
      </td>
    </tr>
  {% endfor %}
</tbody>


</table>

</div>


    <!-- Save Button -->
    <div class="mt-6 text-right">
    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save</button>
    </div>

  </div>
  </form>

</section>

  <script>
  function onlyOne(checkbox) {
    const row = checkbox.closest("tr");
    row.querySelectorAll("input[type=checkbox]").forEach(cb => {
      if (cb !== checkbox) cb.checked = false;
    });
  }

  function selectAll(headerCheckbox, classIndex) {
    const columnClass = `class${classIndex}`;
    const checkboxes = document.querySelectorAll(`.${columnClass}`);

    checkboxes.forEach(cb => {
      const row = cb.closest("tr");
      const otherBoxes = row.querySelectorAll("input[type=checkbox]:not(.class" + classIndex + ")");
      const anyOtherChecked = Array.from(otherBoxes).some(c => c.checked);
      if (!anyOtherChecked) cb.checked = headerCheckbox.checked;
    });
  }
</script>

   {% endblock %}


