{% extends 'foresight_app/dashboard/base.html' %}

{% block content %}


<!-- Add Post Button -->
<button onclick="openPostModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-6">Add
    Post</button>

<!-- Add Post Modal -->
<div id="addPostModal" class="post-modal hidden">
    <div class="post-modal-content">
        <span class="post-close" onclick="closePostModal()">&times;</span>
        <h3 class="text-xl font-bold mb-4">Add New Post</h3>
        <form id="postForm" action="{% url 'post_create' %}" method="POST" enctype="multipart/form-data"
            class="space-y-4">
            {% csrf_token %}
            <input type="text" id="postHeading" name="heading" placeholder="Heading" required class="input-field" />
            <textarea id="postContent" name="content" placeholder="Content" required
                class="input-field resize-y"></textarea>
            <input type="file" id="postImage" name="image" accept="image/*" required class="input-field" />
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add Post</button>
        </form>
    </div>
</div>

<!-- Edit Post Modal -->
<div id="post_edit" class="post-modal hidden">
    <div class="post-modal-content">
        <span class="post-close" onclick="closePostEditModal()">&times;</span>
        <h3 class="text-xl font-bold mb-4">Edit Post</h3>
        <form id="editPostForm" method="POST" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="editPostId" name="post_id">
            <input type="text" id="editPostHeading" name="heading" placeholder="Heading" required class="input-field" />
            <textarea id="editPostContent" name="content" placeholder="Content" required
                class="input-field resize-y"></textarea>
            <input type="file" id="editPostImage" name="image" accept="image/*" class="input-field" />
            <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Save
                Changes</button>
        </form>
    </div>
</div>

<!-- Delete Post Modal -->
<div id="post_delete" class="post-modal hidden">
    <div class="post-modal-content text-center">
        <span class="post-close" onclick="closePostDeleteModal()">&times;</span>
        <h3 class="text-lg font-semibold mb-6">Are you sure you want to delete this post?</h3>
        <form id="deletePostForm" method="POST" class="space-x-4">
            {% csrf_token %}
            <input type="hidden" id="deletePostId" name="post_id">
            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Yes, Delete</button>
            <button type="button" onclick="closePostDeleteModal()"
                class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
        </form>
    </div>
</div>
  <div class="pt-10 md:ml-64 p-4 space-y-10">

<!-- Posts Table -->
<section id="postss" class="bg-white p-6 rounded-lg shadow-md">
  <h2 class="text-2xl font-semibold mb-6 text-center">Post Management</h2>

    <div class="overflow-x-auto bg-white shadow rounded-lg mt-6">
        {% if posts %}
        <table class="w-full text-sm text-left table-fixed">
  <thead class="bg-gray-100 text-gray-700">
    <tr>
      <th class="border p-2 w-2/12">Title</th>
      <th class="border p-2 hidden md:table-cell w-5/12">Content</th>
      <th class="border p-2 hidden md:table-cell w-2/12">Image</th>
      <th class="border p-2 w-3/12">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for post in posts %}
    <tr class="hover:bg-gray-50">
      <td class="border p-2 truncate">{{ post.heading }}</td>

      <!-- Desktop: Content -->
      <td class="border p-2 hidden md:table-cell break-words whitespace-normal line-clamp-2">
        {{ post.content }}
      </td>

      <!-- Desktop: Image -->
      <td class="border p-2 hidden md:table-cell">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post Image" class="w-20 h-20 object-cover rounded" />
        {% else %}
        <span class="text-gray-400">No Image</span>
        {% endif %}
      </td>

      <!-- Actions -->
      <td class="border p-2 space-x-1 flex flex-wrap gap-1">
        <!-- Mobile Only View Button -->
        <button class="bg-indigo-500 text-white px-2 py-1 rounded text-xs md:hidden"
          onclick="openViewModal('{{ post.heading }}', `{{ post.content|escapejs }}`, {% if post.image %}
  '{{ post.image.url }}'
{% else %}
  ''
{% endif %}
, {{ post.pk }})">View</button>

        <button class="bg-green-500 text-white px-2 py-1 rounded text-xs sm:text-sm"
          onclick="openPostEditModal(this.closest('tr'), {{ post.pk }})">Edit</button>

        <button class="bg-red-500 text-white px-2 py-1 rounded text-xs sm:text-sm"
          onclick="openPostDeleteModal({{ post.pk }})">Delete</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

        {% else %}
        <p class="text-center font-semibold mt-4">No posts found.</p>
        {% endif %}
    </div>
   
</section>
<!-- View Modal (Mobile only) -->
<div id="viewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg p-6 w-[90%] max-w-md space-y-4 relative">
    <button onclick="closeViewModal()" class="absolute top-2 right-4 text-xl font-bold text-gray-600">&times;</button>
    <h2 class="text-xl font-semibold" id="viewModalTitle"></h2>
    <p class="text-gray-700" id="viewModalContent"></p>
    <img id="viewModalImage" src="" alt="Post Image" class="w-full h-48 object-cover rounded hidden" />
   
  </div>
</div>
<script>
  function openViewModal(title, content, imageUrl, postId) {
    document.getElementById("viewModalTitle").innerText = title;
    document.getElementById("viewModalContent").innerText = content;

    const imgEl = document.getElementById("viewModalImage");
    if (imageUrl) {
      imgEl.src = imageUrl;
      imgEl.classList.remove("hidden");
    } else {
      imgEl.classList.add("hidden");
    }

   

    document.getElementById("viewModal").classList.remove("hidden");
    document.getElementById("viewModal").classList.add("flex");
  }

  function closeViewModal() {
    document.getElementById("viewModal").classList.add("hidden");
    document.getElementById("viewModal").classList.remove("flex");
  }
</script>

<!-- Scoped Tailwind-compatible Modal Styles -->
<style>
    .post-modal {
        position: fixed;
        z-index: 50;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
    }

    .post-modal-content {
        background: white;
        padding: 2rem;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 28rem;
        position: relative;
    }

    .post-close {
        position: absolute;
        top: 0.5rem;
        right: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #4b5563;
        cursor: pointer;
    }

    .input-field {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
    }
</style>

<!-- JS Functions -->
<script>
    const addModal = document.getElementById("addPostModal");
    const editModal = document.getElementById("post_edit");
    const deleteModal = document.getElementById("post_delete");

    const editForm = document.getElementById("editPostForm");
    const deleteForm = document.getElementById("deletePostForm");

    function openPostModal() {
        addModal.style.display = "flex";
    }

    function closePostModal() {
        addModal.style.display = "none";
    }

    function openPostEditModal(row, pk) {
        const heading = row.querySelector('td:nth-child(1)').innerText;
        const content = row.querySelector('td:nth-child(2)').innerText;

        document.getElementById("editPostHeading").value = heading;
        document.getElementById("editPostContent").value = content;
        document.getElementById("editPostId").value = pk;

        editForm.action = `/edit_post/${pk}/`;
        editModal.style.display = "flex";
    }

    function closePostEditModal() {
        editModal.style.display = "none";
    }

    function openPostDeleteModal(pk) {
        document.getElementById("deletePostId").value = pk;
        deleteForm.action = `/delete_post/${pk}/`;
        deleteModal.style.display = "flex";
    }

    function closePostDeleteModal() {
        deleteModal.style.display = "none";
    }
</script>
{% endblock %}