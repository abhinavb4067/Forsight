{% extends 'foresight_app/dashboard/base.html' %}

{% block content %}
 <!-- Converted to Tailwind CSS -->
<section class="bg-white pt-24 p-10 rounded-lg shadow-md md:ml-64">

  <h2 class="text-2xl font-semibold mb-4 text-center">Registered Students</h2>
  <div id="student-dashboard">

    <!-- Search Form -->
 <form method="get" class="flex flex-col md:flex-row flex-wrap gap-2 mb-4" id="student-search-form">
  <input  type="text" name="student_q" placeholder="Search by name" value="{{ query }}"   class="input-field w-full md:flex-1" >
  <label for="student-from" class="self-center">From Date</label>
  <input type="date" id="student-from" name="student_from" value="{{ date_from }}"   class="input-field w-full md:flex-1" >
  <label for="student-to" class="self-center">To Date</label>
  <input type="date" id="student-to" name="student_to" value="{{ date_to }}"   class="input-field w-full md:flex-1" >
  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full sm:w-auto">Search</button>

  <a href="{% url 'export_csv' %}?student_q={{ query }}&student_from={{ date_from }}&student_to={{ date_to }}"
     class="px-4 py-2 border border-[#000000] rounded">
     Export CSV
  </a>
  
</form>

<style>.input-field {
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  width: 100%;         /* Ensures full width on mobile */
  min-width: 0;        /* Fixes flexbox shrink issues */
}
</style>

    <div class="overflow-x-auto">
      {% if students %}
      <table class="min-w-full border border-[#cccccc]">
        <thead>
          <tr class="bg-[rgba(0,0,0,0.05)]">
            <th class="px-4 py-2 hidden md:table-cell  text-left">Date</th>
            <th class="px-4 py-2 text-left">Name</th>
            <th class="px-4 py-2 hidden md:table-cell  text-left">Email</th>
            <th class="px-4 py-2 hidden md:table-cell  text-left">Phone</th>
            <th class="px-4 py-2 hidden md:table-cell text-left">Qualification</th>
            <th class="px-4 py-2 hidden md:table-cell text-left">Course</th>
            <th class="px-4 py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr class="border-t border-[#cccccc]">
            <td class="px-4 hidden md:table-cell  py-2">{{ s.created_at|date:"F j, Y" }}</td>
            <td class="px-4 py-2">{{ s.full_name }}</td>
            <td class="px-4 hidden md:table-cell py-2">
              <a href="mailto:{{ enquiry.email }}" class="text-inherit no-underline">{{ s.email }}</a>
            </td>
            <td class="px-4 hidden md:table-cell py-2 cursor-pointer text-inherit no-underline" onclick="openWhatsApp('{{ s.phone }}')">
              {{ s.phone }}
            </td>
            <td class="hidden md:table-cell px-4 py-2">{{ s.qualification }}</td>
            <td class="hidden md:table-cell px-4 py-2">{{ s.course }}</td>
           <td class="px-4 py-2">
  <div class="flex gap-1 mb-1">
<button onclick="openViewModal({{ s.id }})" class="bg-[#007bff] text-white px-2 py-1 rounded hover:bg-[#0056b3]">View</button>
    <button onclick="download({{ s.id }})" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-[#0056b3]">Download</button>
  </div>
  <div class="flex gap-1">
    <button onclick="openEditModal({{ s.id }})" class="bg-[#007bff] text-white px-2 py-1 rounded hover:bg-[#0056b3]">Edit</button>
    <button onclick="confirmDelete({{ s.id }})" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-800">Delete</button>
  </div>
</td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-center font-bold mt-5">No student records found.</p>
      {% endif %}
    </div>
  </div>
</section>
<!-- Student View Modal -->
<div id="viewStudentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeviewStudentModal(event)">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl mx-auto p-6" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">ğŸ“ Student Profile</h2>
<button class="close text-2xl font-bold text-gray-600 hover:text-red-600" onclick="closeviewStudentModal(event)">
  &times;
</button>
    </div>
    <div id="student-details-body" class="overflow-y-auto max-h-[70vh] text-sm text-gray-700">
      Loading...
    </div>
  </div>
</div>
<!-- Student delete Modal -->
<!-- Student delete Modal -->
<div id="deleteConfirmModal"
   class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
     onclick="closeDeleteModal(event)">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative" onclick="event.stopPropagation()">
<button class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-red-600 close-icon" onclick="closeDeleteModal(event)">&times;</button>
    <h2 class="text-lg font-semibold mb-4 text-center">Are you sure you want to delete this student?</h2>
    <div class="flex justify-center gap-4">
      <button onclick="deleteStudent()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Yes, Delete</button>
      <button onclick="closeDeleteModal()" class="bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
    </div>
  </div>
</div>

<script>
  let studentToDelete = null;

  function confirmDelete(studentId) {
    studentToDelete = studentId;
    document.getElementById("deleteConfirmModal").classList.remove("hidden");
  }

function closeDeleteModal(event) {
  // Close if:
  // - clicked outside the modal (overlay click), or
  // - clicked the close icon (button with aria-label or a specific id)
  if (!event || event.target.id === "deleteConfirmModal" || event.target.classList.contains("close-icon")) {
    document.getElementById("deleteConfirmModal").classList.add("hidden");
    studentToDelete = null;
  }
}

  function deleteStudent() {
    fetch(`/students/delete/${studentToDelete}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',  // or get from cookie dynamically
        'Content-Type': 'application/json',
      },
    })
    .then(response => {
      if (response.ok) {
        window.location.href = '/all_students/';
      } else {
        alert('Failed to delete the student.');
      }
    });
  }
</script>

<!-- Edit Student Modal -->
<div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeEditModal(event)">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-auto max-h-[90vh] overflow-y-auto p-6 relative" onclick="event.stopPropagation()">

<button class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-red-600 close" onclick="closeEditModal(event)">&times;</button>
    <h2 class="text-xl font-semibold mb-4">âœï¸ Edit Student</h2>
    <form id="editStudentForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Basic Info -->
        <input type="hidden" name="student_id" id="edit-student-id" />
        <div>
          <label class="block font-medium">Full Name</label>
          <input name="full_name" id="edit-full_name" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Email</label>
          <input name="email" id="edit-email" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Phone</label>
          <input name="phone" id="edit-phone" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Whatsapp</label>
          <input name="whatsapp" id="edit-whatsapp" class="w-full border rounded px-3 py-2" />
        </div>

        <div>
          <label class="block font-medium">Father's Name</label>
          <input name="father_name" id="edit-father_name" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Father's Phone</label>
          <input name="father_phone" id="edit-father_phone" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Mother's Name</label>
          <input name="mother_name" id="edit-mother_name" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Mother's Phone</label>
          <input name="mother_phone" id="edit-mother_phone" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Gender</label>
          <input name="gender" id="edit-gender" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Date of Birth</label>
          <input type="date" name="dob" id="edit-dob" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Qualification</label>
          <input name="qualification" id="edit-qualification" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">Course</label>

  <select id="edit-course" name="course" class="w-full border rounded px-3 py-2" required>
    <option value="" disabled selected>Select a course</option>
    <option value="Hotel and Hospitality Management">Hotel and Hospitality Management</option>
    <option value="Diploma in Food Production & Culinary Arts">Diploma in Food Production & Culinary Arts</option>
    <option value="Diploma in Housekeeping Operations">Diploma in Housekeeping Operations</option>
    <option value="Diploma in Food and Beverage Service">Diploma in Food and Beverage Service</option>
    <option value="Diploma in Kitchen Supervisor">Diploma in Kitchen Supervisor</option>
    <option value="Diploma in Front Office Services">Diploma in Front Office Services</option>
    <option value="Diploma in Kitchen & Area Sanitizing">Diploma in Kitchen & Area Sanitizing</option>
    <option value="Diploma in USPH & HACCP Compliance">Diploma in USPH & HACCP Compliance</option>
  </select>

        </div>
        <div class="md:col-span-2">
          <label class="block font-medium">Address</label>
          <textarea name="address" id="edit-address" class="w-full border rounded px-3 py-2"></textarea>
        </div>

        <!-- Academic Info -->
        <div>
          <label class="block font-medium">College Name</label>
          <input name="college_name" id="edit-college_name" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">College Year</label>
          <input name="college_year" id="edit-college_year" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">College Score</label>
          <input name="college_score" id="edit-college_score" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">12th School</label>
          <input name="school_12" id="edit-school_12" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">12th Year</label>
          <input name="year_12" id="edit-year_12" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">12th Score</label>
          <input name="score_12" id="edit-score_12" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">10th School</label>
          <input name="school_10" id="edit-school_10" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">10th Year</label>
          <input name="year_10" id="edit-year_10" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-medium">10th Score</label>
          <input name="score_10" id="edit-score_10" class="w-full border rounded px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <label class="block font-medium">Achievements</label>
          <textarea name="achievements" id="edit-achievements" class="w-full border rounded px-3 py-2"></textarea>
        </div>
      </div>

      <div class="mt-6">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update Student</button>
      </div>
    </form>
  </div>
</div>
<script>
  function openEditModal(studentId) {
    fetch(`/students/details/${studentId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('edit-student-id').value = studentId;
        document.getElementById('edit-full_name').value = data.full_name || '';
        document.getElementById('edit-email').value = data.email || '';
        document.getElementById('edit-phone').value = data.phone || '';
        document.getElementById('edit-whatsapp').value = data.whatsapp || '';
        document.getElementById('edit-father_name').value = data.father_name || '';
        document.getElementById('edit-father_phone').value = data.father_phone || '';
        document.getElementById('edit-mother_name').value = data.mother_name || '';
        document.getElementById('edit-mother_phone').value = data.mother_phone || '';
        document.getElementById('edit-gender').value = data.gender || '';
        document.getElementById('edit-dob').value = data.dob || '';
        document.getElementById('edit-qualification').value = data.qualification || '';
        document.getElementById('edit-course').value = data.course || '';
        document.getElementById('edit-address').value = data.address || '';

        document.getElementById('edit-college_name').value = data.college_name || '';
        document.getElementById('edit-college_year').value = data.college_year || '';
        document.getElementById('edit-college_score').value = data.college_score || '';
        document.getElementById('edit-school_12').value = data.school_12 || '';
        document.getElementById('edit-year_12').value = data.year_12 || '';
        document.getElementById('edit-score_12').value = data.score_12 || '';
        document.getElementById('edit-school_10').value = data.school_10 || '';
        document.getElementById('edit-year_10').value = data.year_10 || '';
        document.getElementById('edit-score_10').value = data.score_10 || '';
        document.getElementById('edit-achievements').value = data.achievements || '';

        document.getElementById('editStudentForm').action = `/students/edit/${studentId}/`;
        document.getElementById('editStudentModal').classList.remove('hidden');
      });
  }

  function closeEditModal(event) {
    if (event.target.id === 'editStudentModal' || event.target.closest('.close')) {
      document.getElementById('editStudentModal').classList.add('hidden');
    }
  }
</script>

<script>
  function openViewModal(studentId) {
    fetch(`/students/details/${studentId}/`)
      .then(response => response.json())
      .then(data => {
        const html = `
          <div class="flex flex-col md:flex-row gap-6">
            <div class="md:w-1/3 text-center">
              ${data.photo
                ? `<img src="${data.photo}" class="rounded border shadow-md mx-auto" style="width: 200px; height: 200px; object-fit: cover;">`
                : '<div class="text-gray-400">No photo</div>'}
            </div>
            <div class="md:w-2/3">
              <table class="w-full border border-gray-200">
                <tbody>
                  ${renderRow("ğŸ‘¤ Full Name", data.full_name)}
                  ${renderRow("ğŸ“§ Email", data.email)}
                  ${renderRow("ğŸ“ Phone", data.phone)}
                  ${renderRow("ğŸ’¬ Whatsapp", data.whatsapp)}
                  ${renderRow("ğŸ‘¨ Father's Name", data.father_name)}
                  ${renderRow("ğŸ“ Father's Phone", data.father_phone)}
                  ${renderRow("ğŸ‘© Mother's Name", data.mother_name)}
                  ${renderRow("ğŸ“ Mother's Phone", data.mother_phone)}
                  ${renderRow("âš§ï¸ Gender", data.gender)}
                  ${renderRow("ğŸ‚ Date of Birth", data.dob)}
                  ${renderRow("ğŸ“ Qualification", data.qualification)}
                  ${renderRow("ğŸ“š Course", data.course)}
                  ${renderRow("ğŸ  Address", data.address)}

                  <tr class="bg-gray-100 font-semibold text-sm">
                    <th class="p-2 text-left" colspan="2">ğŸ“˜ Academic Info</th>
                  </tr>
                  ${renderRow("ğŸ« College Name", data.college_name)}
                  ${renderRow("ğŸ“… College Year", data.college_year)}
                  ${renderRow("ğŸ“Š College Score", data.college_score)}
                  ${renderRow("ğŸ« 12th School", data.school_12)}
                  ${renderRow("ğŸ“… 12th Year", data.year_12)}
                  ${renderRow("ğŸ“Š 12th Score", data.score_12)}
                  ${renderRow("ğŸ« 10th School", data.school_10)}
                  ${renderRow("ğŸ“… 10th Year", data.year_10)}
                  ${renderRow("ğŸ“Š 10th Score", data.score_10)}
                  ${renderRow("ğŸ† Achievements", data.achievements)}

                  ${renderRow("ğŸ•“ Registered At", data.created_at)}
                </tbody>
              </table>
            </div>
          </div>
        `;

        document.getElementById('student-details-body').innerHTML = html;
        document.getElementById('viewStudentModal').classList.remove('hidden');
      })
      .catch(err => {
        document.getElementById('student-details-body').innerHTML = 'Error loading student details.';
        console.error(err);
      });

    function renderRow(label, value) {
      return `
        <tr class="border-t border-gray-200">
          <th class="text-left p-2 align-top w-1/3 font-medium">${label}</th>
          <td class="p-2">${value || 'â€”'}</td>
        </tr>
      `;
    }
  }

  function closeviewStudentModal(event) {
    if (event.target.id === 'viewStudentModal' || event.target.closest('.close')) {
      document.getElementById('viewStudentModal').classList.add('hidden');
    }
  }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  async function download(studentId) {
    const { jsPDF } = window.jspdf;
    const response = await fetch(`/students/details/${studentId}/`);
    const data = await response.json();
    const doc = new jsPDF();

    // Header
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('FORESIGHT INSTITUTE OF HOTEL MANAGEMENT', 105, 15, null, null, 'center');
    doc.setFontSize(12);
    doc.text('BATCH 2025â€“2026', 105, 22, null, null, 'center');
    doc.setFontSize(10);
    doc.text('KOZHIKODE', 105, 27, null, null, 'center');

    doc.line(20, 30, 190, 30);

    // Title
    doc.setFontSize(13);
    doc.setFont('helvetica', 'bold');
    doc.text('STUDENT ADMISSION FORM', 105, 38, null, null, 'center');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('for diploma in hotel management', 105, 43, null, null, 'center');

    // Photo
    doc.rect(150, 35, 40, 40);
    doc.setFontSize(8);
    // doc.text('attach passport size photo', 152, 78);

    let y = 55;
    const labelX = 25;
    const valueX = 90;

    function addSection(title) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text(title, 20, y);
      y += 6;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
    }

    function addField(label, value) {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(`${label}:`, labelX, y);
      doc.text(`${value || 'â€”'}`, valueX, y);
      y += 5;
    }

    // Sections
    addSection('1. Personal Information');
    addField('Full Name', data.full_name);
    addField('Date of Birth', data.dob);
    addField('Gender', data.gender);
    addField('Phone Number', data.phone);
    addField('Whatsapp', data.whatsapp);
    addField('Email Address', data.email);
    // addField('Adhaar Number', data.adhaar_number);
    addField('Qualification', data.qualification);
    addField('Course', data.course);
    addField('Address', data.address);

    addSection('2. Parent Information');
    addField("Father's Name", data.father_name);
    addField("Father's Phone", data.father_phone);
    addField("Mother's Name", data.mother_name);
    addField("Mother's Phone", data.mother_phone);

    addSection('3. Academic Information');
    addField('College Name', data.college_name);
    addField('College Year', data.college_year);
    addField('College Score', data.college_score);
    addField('12th School', data.school_12);
    addField('12th Year', data.year_12);
    addField('12th Score', data.score_12);
    addField('10th School', data.school_10);
    addField('10th Year', data.year_10);
    addField('10th Score', data.score_10);
    addField('Achievements', data.achievements);

    addSection('5. Record ');
    addField('Submitted On', data.created_at);

    // Photo load & save
    if (data.photo) {
      const img = new Image();
      img.src = data.photo;
      img.onload = function () {
        doc.addImage(img, 'JPEG', 150, 35, 40, 40);
        doc.save(`${ data.full_name}`);
      };
    } else {
      doc.save(`${ data.full_name}.pdf`);
    }
  }
</script>
   {% endblock %}


